<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players List - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-md relative">
    <div class="max-w-7xl mx-auto px-4 py-3 relative flex items-center justify-center">
      <p onclick="window.location.href='admin.html'" class="absolute left-4 text-gray-700 cursor-pointer">
        <i class="fas fa-arrow-left text-2xl"></i>
      </p>
      <h1 class="text-xl font-bold text-gray-800">Players List</h1>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 md:p-6 space-y-6 overflow-auto flex-grow">
    <div class="bg-white shadow rounded-xl p-4 border border-gray-200">
      
      <!-- Search Input -->
      <div class="mb-5">
        <input type="text" id="searchUserId" placeholder="Search by User ID..." 
               class="w-full border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-blue-200 focus:outline-none" />
      </div>

      <!-- Buttons -->
      <div class="flex justify-center items-center mb-5 space-x-3">
        <button id="allPlayerBtn" class="px-4 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition">All Player (0)</button>
        <button id="tourPlayerBtn" class="px-4 py-1.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition">Tour Player (0)</button>
        <button id="completeTourBtn" class="hidden px-4 py-1.5 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition">Complete</button>
      </div>

      <!-- Players Grid -->
      <div id="playersCardContainer" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        <div class="col-span-full text-center text-gray-500" id="loadingText">Loading players...</div>
      </div>
    </div>
  </main>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBscFHFPGGsWYNe91JO5meCzueVcDg4gFw",
      authDomain: "dls12364.firebaseapp.com",
      projectId: "dls12364",
      storageBucket: "dls12364.appspot.com",
      messagingSenderId: "431397971734",
      appId: "1:431397971734:web:0cb1a8b53ee09157425237",
      measurementId: "G-B75EB4GGRV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentFilter = "all"; 
    let allPlayersData = [];
    let tourPlayersData = [];

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        setupRealtimeListeners();
      }
    });

    function setupRealtimeListeners() {
      const allBtn = document.getElementById("allPlayerBtn");
      const tourBtn = document.getElementById("tourPlayerBtn");

      // Free Players
      const freeQuery = query(collection(db, "playersform"), where("type", "==", "free"));
      onSnapshot(freeQuery, snapshot => {
        allBtn.textContent = `All Player (${snapshot.size})`;
        allPlayersData = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
        if (currentFilter === "all") renderPlayers(allPlayersData);
      });

      // Paid Players
      const paidQuery = query(collection(db, "playersform"), where("type", "==", "paid"));
      onSnapshot(paidQuery, snapshot => {
        tourBtn.textContent = `Tour Player (${snapshot.size})`;
        tourPlayersData = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
        if (currentFilter === "tour") renderPlayers(tourPlayersData);
      });
    }

    document.getElementById("allPlayerBtn").addEventListener("click", () => {
      currentFilter = "all";
      toggleActiveButton("allPlayerBtn");
      document.getElementById("completeTourBtn").classList.add("hidden");
      renderPlayers(allPlayersData);
    });

    document.getElementById("tourPlayerBtn").addEventListener("click", () => {
      currentFilter = "tour";
      toggleActiveButton("tourPlayerBtn");
      document.getElementById("completeTourBtn").classList.remove("hidden");
      renderPlayers(tourPlayersData);
    });

    function toggleActiveButton(activeId) {
      const allBtn = document.getElementById("allPlayerBtn");
      const tourBtn = document.getElementById("tourPlayerBtn");

      if (activeId === "allPlayerBtn") {
        allBtn.className = "px-4 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition";
        tourBtn.className = "px-4 py-1.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition";
      } else {
        tourBtn.className = "px-4 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition";
        allBtn.className = "px-4 py-1.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition";
      }
    }

    async function renderPlayers(playersArray) {
      const container = document.getElementById("playersCardContainer");
      const searchTerm = document.getElementById("searchUserId").value.trim().toLowerCase();

      if (!playersArray.length) {
        container.innerHTML = `<div class="col-span-full text-center text-gray-500">No players found.</div>`;
        return;
      }

      container.innerHTML = "";

      for (const item of playersArray) {
        const p = item.data;
        const docId = item.id;

        // Fetch User ID
        let userIdText = "N/A";
        if (p.uid) {
          try {
            const userDoc = await getDoc(doc(db, "users", p.uid));
            if (userDoc.exists()) {
              userIdText = userDoc.data().userId || "N/A";
            }
          } catch (err) {
            console.error("Failed to fetch userId:", err);
          }
        }

        // Filter by search
        if (searchTerm && !userIdText.toLowerCase().includes(searchTerm)) continue;

        const imageUrl = p.photoUrl || "https://via.placeholder.com/80?text=No+Image";
        const imageId = `img-${docId}`;
        const fileInputId = `file-${docId}`;
        const photoUrlInputId = `photourl-${docId}`;
        const updateBtnId = `update-${docId}`;
        const typeBtnId = `type-${docId}`;

        const card = document.createElement("div");
        card.className = "bg-white shadow-md rounded-lg p-4 border border-gray-200 hover:shadow-xl transition";

        card.innerHTML = `
          <div class="flex items-center mb-4">
            <img id="${imageId}" src="${imageUrl}" class="w-12 h-12 rounded-full object-cover border border-gray-300 shadow-sm mr-3" />
            <div>
              <div class="text-sm font-bold text-gray-800">${p.team || "N/A"}</div>
              <div id="${typeBtnId}" class="text-xs mt-2 inline-block cursor-pointer px-2 py-0.5 rounded ${
                p.type === "paid" ? "bg-green-100 text-green-700" : "bg-blue-100 text-blue-700"
              }">
                ${p.type || "N/A"}
              </div>
            </div>
            <input type="file" id="${fileInputId}" class="hidden" accept="image/*" />
            <button id="${updateBtnId}" class="ml-auto text-xs text-blue-600 hover:underline">Update</button>
          </div>

          <input type="text" id="${photoUrlInputId}" value="${imageUrl}" class="w-full text-xs text-gray-700 mb-3 border rounded px-2 py-1 bg-white focus:ring focus:ring-blue-200" />

          <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-center"><i class="fas fa-user text-blue-500 w-5"></i>Username:<span class="ml-1">${p.username || "N/A"}</span></li>
            <li class="flex items-center"><i class="fas fa-id-badge text-purple-500 w-5"></i>User ID:<span class="ml-1">${userIdText}</span></li>
            <li class="flex items-center"><i class="fas fa-star text-yellow-500 w-5"></i>DLS Rating:<span class="ml-1">${p.dlsRating ?? "N/A"}</span></li>
            <li class="flex items-center"><i class="fas fa-birthday-cake text-pink-500 w-5"></i>Age:<span class="ml-1">${p.age ?? "N/A"} Year</span></li>
            <li class="flex items-center"><i class="fas fa-futbol text-green-500 w-5"></i>Played:<span class="ml-1">${p.yearsPlayed ?? "N/A"} Year</span></li>
          </ul>
        `;

        container.appendChild(card);

        // Update Logic
        const updateBtn = card.querySelector(`#${updateBtnId}`);
        const photoUrlInput = card.querySelector(`#${photoUrlInputId}`);
        const imageEl = card.querySelector(`#${imageId}`);
        updateBtn.addEventListener("click", async () => {
          const newUrl = photoUrlInput.value.trim();
          if (!newUrl) { Swal.fire("Error", "Photo URL cannot be empty.", "error"); return; }
          try {
            await updateDoc(doc(db, "playersform", docId), { photoUrl: newUrl });
            imageEl.src = newUrl;
            Swal.fire("Success", "Photo URL updated successfully!", "success");
          } catch {
            Swal.fire("Error", "Failed to update photo URL.", "error");
          }
        });

        // File upload
        const fileInput = card.querySelector(`#${fileInputId}`);
        updateBtn.addEventListener("dblclick", () => fileInput.click());
        fileInput.addEventListener("change", async e => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const storageRef = ref(storage, `players/${docId}/photo.jpg`);
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);
            await updateDoc(doc(db, "playersform", docId), { photoUrl: downloadURL });
            imageEl.src = downloadURL;
            photoUrlInput.value = downloadURL;
            Swal.fire("Success", "Photo uploaded successfully!", "success");
          } catch {
            Swal.fire("Error", "Failed to upload photo.", "error");
          }
        });

        // Type toggle
        const typeBtn = card.querySelector(`#${typeBtnId}`);
        typeBtn.addEventListener("click", async () => {
          const newType = p.type === "paid" ? "free" : "paid";
          try {
            await updateDoc(doc(db, "playersform", docId), { type: newType });
            Swal.fire("Success", `Player type changed to ${newType}!`, "success");
          } catch {
            Swal.fire("Error", "Failed to update player type.", "error");
          }
        });
      }

      if (container.innerHTML === "") {
        container.innerHTML = `<div class="col-span-full text-center text-gray-500">No players match the search.</div>`;
      }
    }

    // Search input listener
    document.getElementById("searchUserId").addEventListener("keyup", () => {
      if (currentFilter === "all") renderPlayers(allPlayersData);
      else renderPlayers(tourPlayersData);
    });

    document.getElementById("completeTourBtn").addEventListener("click", async () => {
      const result = await Swal.fire({
        title: "Are you sure?",
        text: "This will mark all Tour Players as free!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, complete it!",
        cancelButtonText: "Cancel"
      });
      if (!result.isConfirmed) return;

      try {
        const paidQuery = query(collection(db, "playersform"), where("type", "==", "paid"));
        const paidPlayersSnapshot = await new Promise((resolve, reject) => {
          onSnapshot(paidQuery, snapshot => resolve(snapshot), reject);
        });

        const promises = [];
        paidPlayersSnapshot.forEach(docSnap => {
          promises.push(updateDoc(doc(db, "playersform", docSnap.id), { type: "free" }));
        });
        await Promise.all(promises);
        Swal.fire("Success", "All Tour Players marked as free!", "success");
      } catch {
        Swal.fire("Error", "Failed to complete tour.", "error");
      }
    });
  </script>

</body>
</html>
